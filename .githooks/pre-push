#!/bin/bash

set -e

echo "ğŸš€ å¼€å§‹æ‰§è¡Œé¢„æ¨é€æ£€æŸ¥..."

# æ£€æŸ¥1: æ‰§è¡Œä»£ç æ ¼å¼åŒ–
echo "ğŸ¨ æ£€æŸ¥1: æ‰§è¡Œä»£ç æ ¼å¼åŒ–..."
yarn format

# æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«ä¿®æ”¹
if git diff --name-only --exit-code; then
    echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆï¼Œæ²¡æœ‰æ–‡ä»¶ä¿®æ”¹"
else
    echo "âŒ ä»£ç æ ¼å¼åŒ–åå‘ç°æ–‡ä»¶è¢«ä¿®æ”¹ï¼Œè¯·å…ˆæäº¤è¿™äº›ä¿®æ”¹"
    git diff --name-only
    exit 1
fi

# æ£€æŸ¥2: æ‰§è¡Œç±»å‹æ£€æŸ¥
echo "ğŸ” æ£€æŸ¥2: æ‰§è¡Œç±»å‹æ£€æŸ¥..."
if yarn type-check; then
    echo "âœ… ç±»å‹æ£€æŸ¥é€šè¿‡"
else
    echo "âŒ ç±»å‹æ£€æŸ¥å¤±è´¥"
    exit 1
fi

# æ£€æŸ¥3: æ‰§è¡Œä»£ç è§„èŒƒæ£€æŸ¥
echo "ğŸ§¹ æ£€æŸ¥3: æ‰§è¡Œä»£ç è§„èŒƒæ£€æŸ¥..."
lint_output=$(yarn lint:watch 2>&1)
lint_exit_code=$?

if [ $lint_exit_code -eq 0 ] && echo "$lint_output" | grep -q "0 warning"; then
    echo "âœ… ä»£ç è§„èŒƒæ£€æŸ¥é€šè¿‡"
else
    echo "âŒ ä»£ç è§„èŒƒæ£€æŸ¥å¤±è´¥ï¼ˆåŒ…å«é”™è¯¯æˆ–è­¦å‘Šï¼‰"
    echo "$lint_output"
    exit 1
fi

echo "ğŸ‰ æ‰€æœ‰é¢„æ¨é€æ£€æŸ¥é€šè¿‡ï¼"
