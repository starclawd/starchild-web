stages:
  - check_tag
  - build_docker
  - deploy

variables:
  SERVICE_NAME: ${CI_PROJECT_NAME}
  IMAGE_NAME: ${CI_PROJECT_NAME}
  DOCKER_CONTEXT: ${CI_PROJECT_DIR}
  DOCKER_FILE: ${CI_PROJECT_DIR}/Dockerfile
  DOCKER_FILE_TESTNET: ${CI_PROJECT_DIR}/Dockerfile.testnet

# --- 新增：强制校验 tag 命名 ---
lint_tag:
  stage: check_tag
  image: alpine:3.18
  retry: 2
  script:
    - 'echo "Checking tag format: ${CI_COMMIT_TAG}"'
    - |
      if echo "${CI_COMMIT_TAG}" | grep -Eq '^(v|test)'; then
        echo "✅ Tag format OK"
      else
        echo "❌ Invalid tag: ${CI_COMMIT_TAG}"
        echo "Tag must start with 'v' (main) or 'test' (testnet)."
        exit 1
      fi
  only:
    - tags
  tags:
    - dev
    - build

check_tag:
  stage: check_tag
  image:
    name: asia-northeast1-docker.pkg.dev/woo-orderly/orderly-devops/gcloud
    entrypoint: ['']
  retry: 2
  needs: [lint_tag] # 先通过 lint 才继续
  script:
    - echo ${IMAGE_NAME}
    - TAG_EXISTS=$(gcloud container images list-tags asia-northeast1-docker.pkg.dev/woo-orderly/orderly-network/${IMAGE_NAME} --filter="tags=${CI_COMMIT_TAG}" --format="value(tags)")
    - echo ${TAG_EXISTS}
    - |
      if [ -z "${TAG_EXISTS}" ]; then
        echo "TAG_EXISTS=false" > build.env 
      else
        echo "TAG_EXISTS=true" > build.env
      fi
  artifacts:
    reports:
      dotenv: build.env
  only:
    - tags
  tags:
    - dev
    - build

build_docker:
  stage: build_docker
  image:
    name: asia-northeast1-docker.pkg.dev/woo-orderly/orderly-devops/executor:v1.9.0-debug
    entrypoint: ['']
  retry: 2
  variables:
    GIT_DEPTH: '0'
  rules:
    # 只在以 v 开头的 tag 跑（视为 main 正式发布）
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_TAG =~ /^v.*$/'
    - when: never
  script:
    - echo ${TAG_EXISTS}
    - |
      if [ "${TAG_EXISTS}" = false ]; then
        /kaniko/executor --context "${DOCKER_CONTEXT}" --dockerfile "${DOCKER_FILE}" \
          --destination "asia-northeast1-docker.pkg.dev/woo-orderly/orderly-network/${IMAGE_NAME}:${CI_COMMIT_TAG}" \
          --snapshotMode=redo --cache=true
      else
        echo "asia-northeast1-docker.pkg.dev/woo-orderly/orderly-network/${IMAGE_NAME}:${CI_COMMIT_TAG} exists, no need to build! Skip building docker image!"
      fi
  dependencies:
    - check_tag
  tags:
    - dev
    - build

build_docker_testnet:
  stage: build_docker
  image:
    name: asia-northeast1-docker.pkg.dev/woo-orderly/orderly-devops/executor:v1.9.0-debug
    entrypoint: ['']
  retry: 2
  variables:
    GIT_DEPTH: '0'
  rules:
    # 只在以 test 开头的 tag 跑（视为 test 分支发布）
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_TAG =~ /^test.*$/'
    - when: never
  script:
    - echo ${TAG_EXISTS}
    - |
      if [ "${TAG_EXISTS}" = false ]; then
        /kaniko/executor --context "${DOCKER_CONTEXT}" --dockerfile "${DOCKER_FILE_TESTNET}" \
          --destination "asia-northeast1-docker.pkg.dev/woo-orderly/orderly-network/${IMAGE_NAME}:${CI_COMMIT_TAG}" \
          --snapshotMode=redo --cache=true
      else
        echo "asia-northeast1-docker.pkg.dev/woo-orderly/orderly-network/${IMAGE_NAME}:${CI_COMMIT_TAG} exists, no need to build! Skip building docker image!"
      fi
  dependencies:
    - check_tag
  tags:
    - dev
    - build

deploy_staging_evm:
  stage: deploy
  image:
    name: asia-northeast1-docker.pkg.dev/woo-orderly/orderly-devops/curl
    entrypoint: ['']
  retry: 2
  variables:
    GIT_DEPTH: '0'
  rules:
    # 仅 test* 的 tag 可触发（并且是手动）
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_TAG =~ /^test.*$/'
    - when: never
  script:
    - echo "Trigger staging-evm helm deploying ... "
    - curl -X POST --fail -F token=${DEPLOY_PRJ_TOKEN} -F "ref=staging-evm" -F "variables[SERVICE_NAME]=${SERVICE_NAME}" -F "variables[TAG]=${CI_COMMIT_TAG}" https://gitlab.com/api/v4/projects/${DEPLOY_PRJ_ID}/trigger/pipeline
  when: manual
  tags:
    - dev
    - build

deploy_prod_evm:
  stage: deploy
  image:
    name: asia-northeast1-docker.pkg.dev/woo-orderly/orderly-devops/curl
    entrypoint: ['']
  retry: 2
  variables:
    GIT_DEPTH: '0'
  rules:
    # 仅 v* 的 tag 可触发（并且是手动）
    - if: '$CI_COMMIT_TAG && $CI_COMMIT_TAG =~ /^v.*$/'
    - when: never
  script:
    - echo "Trigger prod-evm helm deploying ... "
    - curl -X POST --fail -F token=${DEPLOY_PRJ_TOKEN} -F "ref=prod-evm" -F "variables[SERVICE_NAME]=${SERVICE_NAME}" -F "variables[TAG]=${CI_COMMIT_TAG}" https://gitlab.com/api/v4/projects/${DEPLOY_PRJ_ID}/trigger/pipeline
  when: manual
  tags:
    - dev
    - build
